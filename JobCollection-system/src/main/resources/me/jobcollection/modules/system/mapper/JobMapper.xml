<?xml version="1.0" encoding="UTF-8" ?>
<!--MyBatis配置文件-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.jobcollection.modules.system.mapper.JobMapper">
    <insert id="addJobToDept">
        insert into sys_dept_job
        values (#{deptId}, #{jobId});
    </insert>
    <update id="updateJobFromDept">
        update sys_dept_job sdj
        set sdj.dept_id = #{deptId}
        where sdj.job_Id = #{jobId};
    </update>
    <delete id="deleteJobFromDept">
        delete
        from sys_dept_job sdj
        where sdj.job_id = #{jobId};
    </delete>
    <select id="queryJobDetailById" resultType="me.jobcollection.modules.system.service.dto.JobDto">
        SELECT sys_job.*, sys_course.course_name
        FROM sys_job,
             sys_course
        WHERE sys_job.job_id = #{jobId}
          AND sys_job.course_id = sys_course.course_id
    </select>
    <select id="listJob" resultType="me.jobcollection.modules.system.service.dto.JobDto">
        SELECT
        DISTINCT
        sys_job.*,
        sys_course.course_name,
        sys_dept_job.dept_id
        FROM
        sys_dept_user,
        sys_dept_job,
        sys_job,
        sys_course
        <where>
            AND sys_dept_user.dept_id=sys_dept_job.dept_id
            AND sys_dept_job.job_id=sys_job.job_id
            AND sys_job.course_id=sys_course.course_id
            <if test="userId != null">
                AND sys_dept_user.user_id=#{userId}
            </if>
            <if test="year != null and month != null ">
                AND (FROM_UNIXTIME(sys_job.deadline / 1000, '%m') = #{month}
                AND FROM_UNIXTIME(sys_job.deadline / 1000, '%Y') = #{year})
            </if>
            <if test="keyword != null">
                AND sys_job.`job_name` LIKE concat('%',#{keyword},'%')
            </if>
            <if test="success == true">
                AND (SELECT count(*)
                FROM `job_logs`
                WHERE job_logs.job_id = sys_job.job_id) !=0
            </if>
            <if test="success == false">
                AND (SELECT count(*)
                FROM `job_logs`
                WHERE job_logs.job_id = sys_job.job_id) =0
            </if>
            <if test="courseName != null">
                AND sys_course.course_name=#{courseName}
            </if>
        </where>
    </select>
</mapper>